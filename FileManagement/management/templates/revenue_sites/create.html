{% extends 'bases.html' %}
{% load i18n %}

{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'appcss/create.css' %}">
<div class="card">
    <div class="card-header">
        <h3 class="card-title">{% trans 'Create Customer Site' %}</h3>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" id="revenueSiteForm">
            {% csrf_token %}

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal-pane" type="button" role="tab" aria-controls="personal-pane" aria-selected="true">
                        {% trans 'Personal Details' %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="official-tab" data-bs-toggle="tab" data-bs-target="#official-pane" type="button" role="tab" aria-controls="official-pane" aria-selected="false">
                        {% trans 'Official Details' %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="documentation-tab" data-bs-toggle="tab" data-bs-target="#documentation-pane" type="button" role="tab" aria-controls="documentation-pane" aria-selected="false">
                        {% trans 'Documentation (Optional)' %}
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="myTabContent">

                <!-- Tab 1: Personal Details -->
                <div class="tab-pane fade show active" id="personal-pane" role="tabpanel" aria-labelledby="personal-tab">
                    <div class="row">
                        <!-- Full Name -->
                        <div class="col-md-6 mb-3">
                            <label for="id_full_name" class="form-label">{% trans 'पूर्ण नाव / Full Name' %}</label>
                            <input type="text" class="form-control" id="id_full_name" name="full_name"
                                   value="{{ form.full_name.value|default_if_none:'' }}" maxlength="150" required>
                            {% if form.full_name.errors %}
                            <div class="text-danger">{{ form.full_name.errors|join:", " }}</div>
                            {% endif %}
                        </div>

                        <!-- Email -->
                        <div class="col-md-6 mb-3">
                            <label for="id_email" class="form-label">{% trans 'ईमेल / Email' %}</label>
                            <input type="email" class="form-control" id="id_email" name="email"
                                   value="{{ form.email.value|default_if_none:'' }}" required>
                            {% if form.email.errors %}
                            <div class="text-danger">{{ form.email.errors|join:", " }}</div>
                            {% endif %}
                        </div>

                        <!-- Mobile Number -->
                        <div class="col-md-6 mb-3">
                            <label for="id_mobile_number" class="form-label">{% trans 'मोबाइल नंबर / Mobile Number' %}</label>
                            <input type="text" class="form-control" id="id_mobile_number" name="mobile_number"
                                   value="{{ form.mobile_number.value|default_if_none:'' }}" maxlength="10" required>
                            {% if form.mobile_number.errors %}
                            <div class="text-danger">{{ form.mobile_number.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mt-4">
                        <button type="button" class="btn btn-primary next-tab" data-next-tab="official">
                            {% trans 'Next' %} <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Tab 2: Official Details -->
                <div class="tab-pane fade" id="official-pane" role="tabpanel" aria-labelledby="official-tab">
                    <div class="row">
                        <!-- City Survey Number -->
                        <div class="col-md-6 mb-3">
                            <label for="id_nagar_bhumapan_kramank" class="form-label">{% trans 'नगर भूमापन क्रमांक / City Survey Number' %}</label>
                            <input type="text" class="form-control" id="id_nagar_bhumapan_kramank" name="nagar_bhumapan_kramank"
                                   value="{{ form.nagar_bhumapan_kramank.value|default_if_none:'' }}" maxlength="100" required>
                            {% if form.nagar_bhumapan_kramank.errors %}
                            <div class="text-danger">{{ form.nagar_bhumapan_kramank.errors|join:", " }}</div>
                            {% endif %}
                        </div>

                        <!-- Seat Number -->
                        <div class="col-md-6 mb-3">
                            <label for="id_seat_no" class="form-label">{% trans 'सीट क्रमांक / Seat Number' %}</label>
                            <input type="text" class="form-control" id="id_seat_no" name="seat_no"
                                   value="{{ form.seat_no.value|default_if_none:'' }}" maxlength="50" required>
                            {% if form.seat_no.errors %}
                            <div class="text-danger">{{ form.seat_no.errors|join:", " }}</div>
                            {% endif %}
                        </div>

                        <!-- Plot Number -->
                        <div class="col-md-6 mb-3">
                            <label for="id_plot_no" class="form-label">{% trans 'प्लॉट क्रमांक / Plot Number' %}</label>
                            <input type="text" class="form-control" id="id_plot_no" name="plot_no"
                                   value="{{ form.plot_no.value|default_if_none:'' }}" maxlength="50" required>
                            {% if form.plot_no.errors %}
                            <div class="text-danger">{{ form.plot_no.errors|join:", " }}</div>
                            {% endif %}
                        </div>

                        <!-- Square Feet -->
                        <div class="col-md-6 mb-3">
                            <label for="id_square_feet" class="form-label">{% trans 'चौरस फुट / Square Feet' %}</label>
                            <input type="number" step="0.01" class="form-control" id="id_square_feet" name="square_feet"
                                   value="{{ form.square_feet.value|default_if_none:'' }}" required>
                            {% if form.square_feet.errors %}
                            <div class="text-danger">{{ form.square_feet.errors|join:", " }}</div>
                            {% endif %}
                        </div>

                        <!-- Ownership Type -->
                        <div class="col-md-6 mb-3">
                            <label for="id_dharna_dhikhar" class="form-label">{% trans 'धरणा धिकार / Ownership Type' %}</label>
                            <input type="text" class="form-control" id="id_dharna_dhikhar" name="dharna_dhikhar"
                                   value="{{ form.dharna_dhikhar.value|default_if_none:'' }}" maxlength="100" required>
                            {% if form.dharna_dhikhar.errors %}
                            <div class="text-danger">{{ form.dharna_dhikhar.errors|join:", " }}</div>
                            {% endif %}
                        </div>

                        <!-- Ward -->
                        <div class="col-md-6 mb-3">
                            <label for="id_ward" class="form-label">{% trans 'वार्ड / Ward' %}</label>
                            <select class="form-control" id="id_ward" name="ward" required>
                                <option value="">{% trans 'Select Ward' %}</option>
                                {% for ward in form.ward.field.queryset %}
                                <option value="{{ ward.id }}" {% if form.ward.value == ward.id %}selected{% endif %}>{{ ward.ward_number }} - {{ ward.ward_name }}</option>
                                {% endfor %}
                            </select>
                            {% if form.ward.errors %}
                            <div class="text-danger">{{ form.ward.errors|join:", " }}</div>
                            {% endif %}
                        </div>

                        <!-- Drawer -->
                        <div class="col-md-6 mb-3">
                            <label for="id_drawer" class="form-label">{% trans 'ड्रॉवर / Drawer' %}</label>
                            <select class="form-control" id="id_drawer" name="drawer">
                                <option value="">{% trans 'Select Drawer' %}</option>
                                {% for drawer in form.drawer.field.queryset %}
                                <option value="{{ drawer.id }}" {% if form.drawer.value == drawer.id %}selected{% endif %}>{{ drawer.drawer_number }}</option>
                                {% endfor %}
                            </select>
                            {% if form.drawer.errors %}
                            <div class="text-danger">{{ form.drawer.errors|join:", " }}</div>
                            {% endif %}
                        </div>

<!-- Compartment -->
<div class="col-md-6 mb-3">
    <label for="id_compartment" class="form-label">{% trans 'कंपार्टमेंट / Compartment' %}</label>
    <select class="form-control" id="id_compartment" name="compartment">
        <option value="">{% trans 'Select Compartment' %}</option>
        {% if form.compartment.value %}
            {% for compartment in form.compartment.field.queryset %}
                <option value="{{ compartment.id }}" {% if form.compartment.value == compartment.id %}selected{% endif %}>
                    {{ compartment.compartment_number }} (Drawer {{ compartment.drawer.drawer_number }})
                </option>
            {% endfor %}
        {% endif %}
    </select>
    {% if form.compartment.errors %}
    <div class="text-danger">{{ form.compartment.errors|join:", " }}</div>
    {% endif %}
</div>

                        <!-- File Number (Read-only, auto-generated) -->
<div class="col-md-6 mb-3">
    <label for="id_file_no" class="form-label">{% trans 'फाईल क्रमांक / File Number' %}</label>
    <input type="text" class="form-control" id="id_file_no" name="file_no"
           value="{{ next_file_no }}" readonly>
    <small class="form-text text-muted">{% trans 'This number will be assigned upon saving' %}</small>
</div>

                        <!-- Division -->
                        <div class="col-md-6 mb-3">
                            <label for="id_division" class="form-label">{% trans 'विभाग / Division' %}</label>
                            <select class="form-control" id="id_division" name="division" {% if form.division.field.disabled %}disabled{% endif %}>
                                {% for value, label in form.division.field.choices %}
                                <option value="{{ value }}" {% if form.division.value == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            {% if form.division.errors %}
                            <div class="text-danger">{{ form.division.errors|join:", " }}</div>
                            {% endif %}
                        </div>

                        <!-- District -->
                        <div class="col-md-6 mb-3">
                            <label for="id_district" class="form-label">{% trans 'जिल्हा / District' %}</label>
                            <input type="text" class="form-control" id="id_district" name="district"
                                   value="{{ form.district.value|default_if_none:'' }}" maxlength="100" required>
                            {% if form.district.errors %}
                            <div class="text-danger">{{ form.district.errors|join:", " }}</div>
                            {% endif %}
                        </div>

                        <!-- Taluka -->
                        <div class="col-md-6 mb-3">
                            <label for="id_taluka" class="form-label">{% trans 'तालुका / Taluka' %}</label>
                            <input type="text" class="form-control" id="id_taluka" name="taluka"
                                   value="{{ form.taluka.value|default_if_none:'' }}" maxlength="100" required>
                            {% if form.taluka.errors %}
                            <div class="text-danger">{{ form.taluka.errors|join:", " }}</div>
                            {% endif %}
                        </div>

                        <!-- Village -->
                        <div class="col-md-6 mb-3">
                            <label for="id_village" class="form-label">{% trans 'गाव / Village' %}</label>
                            <input type="text" class="form-control" id="id_village" name="village"
                                   value="{{ form.village.value|default_if_none:'' }}" maxlength="100" required>
                            {% if form.village.errors %}
                            <div class="text-danger">{{ form.village.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary previous-tab" data-previous-tab="personal">
                            <i class="fas fa-arrow-left"></i> {% trans 'Previous' %}
                        </button>
                        <button type="submit" name="save_without_docs" class="btn btn-success">
                            <i class="fas fa-save"></i> {% trans 'Save Without Documents' %}
                        </button>
                        <button type="button" class="btn btn-primary next-tab" data-next-tab="documentation">
                            {% trans 'Next' %} <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Tab 3: Documentation (Optional) -->
                <div class="tab-pane fade" id="documentation-pane" role="tabpanel" aria-labelledby="documentation-tab">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        {% trans 'Documentation is optional. You can add documents now or later.' %}
                    </div>

                    <div class="row">
                        <!-- Document Title -->
                        <div class="col-md-6 mb-3">
                            <label for="id_document_title" class="form-label">{% trans 'दस्तऐवजाचे शीर्षक / Document Title' %}</label>
                            <input type="text" class="form-control" id="id_document_title" name="document_title"
                                   value="{{ form.document_title.value|default_if_none:'' }}" maxlength="200">
                            {% if form.document_title.errors %}
                            <div class="text-danger">{{ form.document_title.errors|join:", " }}</div>
                            {% endif %}
                        </div>

                        <!-- Remarks -->
                        <div class="col-md-12 mb-3">
                            <label for="id_remarks" class="form-label">{% trans 'टिप्पण्या / Remarks' %}</label>
                            <textarea class="form-control" id="id_remarks" name="remarks" rows="3">{{ form.remarks.value|default_if_none:'' }}</textarea>
                            {% if form.remarks.errors %}
                            <div class="text-danger">{{ form.remarks.errors|join:", " }}</div>
                            {% endif %}
                        </div>

                        <!-- Document List Section -->
                        <div class="col-12 mb-4">
                            <h5>{% trans 'Document List (Optional)' %}</h5>
                            <div id="documentList">
                                <div class="document-item row mb-3">
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" name="filename[]" placeholder="Document Name (e.g., Aadhar Card)">
                                    </div>
                                    <div class="col-md-5">
                                        <input type="file" class="form-control" name="uploadfile[]" accept="*">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-danger remove-document">Remove</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="addMore" class="btn btn-secondary mt-2">{% trans 'Add More Documents' %}</button>
                        </div>

                        <!-- Hidden field for merged document -->
                        <input type="hidden" id="merged_document_path" name="merged_document_path">
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary previous-tab" data-previous-tab="official">
                            <i class="fas fa-arrow-left"></i> {% trans 'Previous' %}
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> {% trans 'Save With Documents' %}
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tabs
    const tabEl = document.querySelector('#myTab');
    const tab = new bootstrap.Tab(tabEl);

    // Function to check if any file input has a file selected
    function checkFileInputs() {
        const fileInputs = document.querySelectorAll('input[name="uploadfile[]"]');
        const addMoreBtn = document.getElementById('addMore');

        // If there are no document items, enable the button (user can add first document)
        if (fileInputs.length === 0) {
            addMoreBtn.disabled = false;
            return;
        }

        // If there are document items, check if at least one has a file selected
        const hasFile = Array.from(fileInputs).some(input => input.files.length > 0);

        // Enable "Add More" button if at least one file is selected OR if no documents exist
        addMoreBtn.disabled = !hasFile;
    }

    // Dynamic compartment filtering based on drawer selection
    function setupCompartmentFiltering() {
        const drawerSelect = document.getElementById('id_drawer');
        const compartmentSelect = document.getElementById('id_compartment');

        if (drawerSelect && compartmentSelect) {
            // Function to load compartments for a specific drawer
            function loadCompartments(drawerId) {
                console.log('Loading compartments for drawer:', drawerId); // Debug log

                if (!drawerId) {
                    // Clear compartments if no drawer selected
                    compartmentSelect.innerHTML = '<option value="">{% trans "Select Compartment" %}</option>';
                    return;
                }

                // Show loading state
                compartmentSelect.innerHTML = '<option value="">{% trans "Loading compartments..." %}</option>';
                compartmentSelect.disabled = true;

                // Fetch compartments via AJAX
                fetch(`/get-compartments/?drawer_id=${drawerId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Compartments data received:', data); // Debug log

                        compartmentSelect.innerHTML = '<option value="">{% trans "Select Compartment" %}</option>';

                        if (data.compartments && data.compartments.length > 0) {
                            data.compartments.forEach(compartment => {
                                const option = document.createElement('option');
                                option.value = compartment.id;
                                option.textContent = compartment.compartment_number;
                                compartmentSelect.appendChild(option);
                            });
                        } else {
                            const option = document.createElement('option');
                            option.value = "";
                            option.textContent = "{% trans 'No compartments found' %}";
                            compartmentSelect.appendChild(option);
                        }

                        compartmentSelect.disabled = false;

                        // Preselect previously selected compartment if it exists in the new list
                        const previouslySelected = "{{ form.compartment.value|default_if_none:'' }}";
                        if (previouslySelected) {
                            compartmentSelect.value = previouslySelected;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading compartments:', error);
                        compartmentSelect.innerHTML = '<option value="">{% trans "Error loading compartments" %}</option>';
                        compartmentSelect.disabled = false;
                    });
            }

            // Load compartments when drawer selection changes
            drawerSelect.addEventListener('change', function() {
                loadCompartments(this.value);
            });

            // Load compartments on page load if a drawer is already selected
            const initialDrawerId = drawerSelect.value;
            if (initialDrawerId) {
                loadCompartments(initialDrawerId);
            }
        }
    }

    // Add more documents
    document.getElementById('addMore').addEventListener('click', function() {
        const newItem = document.createElement('div');
        newItem.className = 'document-item row mb-3';
        newItem.innerHTML = `
            <div class="col-md-5">
                <input type="text" class="form-control" name="filename[]" placeholder="Document Name">
            </div>
            <div class="col-md-5">
                <input type="file" class="form-control file-input" name="uploadfile[]" accept="*">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger remove-document">Remove</button>
            </div>
        `;
        document.getElementById('documentList').appendChild(newItem);

        // Add event listener to the new file input
        const newFileInput = newItem.querySelector('.file-input');
        newFileInput.addEventListener('change', checkFileInputs);

        // Re-check file inputs after adding new one
        checkFileInputs();
    });

    // Remove document
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-document')) {
            const documentItem = e.target.closest('.document-item');
            documentItem.remove();

            // Re-check file inputs after removal
            setTimeout(checkFileInputs, 0);
        }
    });

    // Add event listeners to existing file inputs
    document.querySelectorAll('input[name="uploadfile[]"]').forEach(input => {
        input.addEventListener('change', checkFileInputs);
    });

    // Initialize button state on page load
    checkFileInputs();

    // Setup compartment filtering
    setupCompartmentFiltering();

    // Tab navigation - Next buttons
    document.querySelectorAll('.next-tab').forEach(button => {
        button.addEventListener('click', function() {
            const nextTabId = this.getAttribute('data-next-tab');
            const currentTab = this.closest('.tab-pane').id.replace('-pane', '');

            // Validate current tab before proceeding
            if (validateTab(currentTab)) {
                // Show next tab using Bootstrap's tab functionality
                const nextTabElement = document.querySelector(`[data-bs-target="#${nextTabId}-pane"]`);
                if (nextTabElement) {
                    const nextTab = new bootstrap.Tab(nextTabElement);
                    nextTab.show();
                }
            }
        });
    });

    // Tab navigation - Previous buttons
    document.querySelectorAll('.previous-tab').forEach(button => {
        button.addEventListener('click', function() {
            const previousTabId = this.getAttribute('data-previous-tab');
            const previousTabElement = document.querySelector(`[data-bs-target="#${previousTabId}-pane"]`);

            if (previousTabElement) {
                bootstrap.Tab.getInstance(previousTabElement).show();
            }
        });
    });

    // Handle "Save Without Documents" button
    document.querySelector('button[name="save_without_docs"]').addEventListener('click', function(e) {
        e.preventDefault();

        // Validate required tabs only (personal and official)
        if (!validateTab('personal') || !validateTab('official')) {
            alert('{% trans "Please fix all validation errors before submitting." %}');

            // Find first invalid tab and show it
            if (!validateTab('personal')) {
                bootstrap.Tab.getInstance(document.querySelector('[data-bs-target="#personal-pane"]')).show();
            } else {
                bootstrap.Tab.getInstance(document.querySelector('[data-bs-target="#official-pane"]')).show();
            }
            return;
        }

        // Submit form without document processing
        document.getElementById('revenueSiteForm').submit();
    });

    // Form submission for documents
    document.getElementById('revenueSiteForm').addEventListener('submit', function(e) {
        // If it's the "Save Without Documents" button, let it submit normally
        if (e.submitter && e.submitter.name === 'save_without_docs') {
            return;
        }

        // For document submission, prevent default and process documents
        e.preventDefault();

        // Check if any files are uploaded
        const hasFiles = document.querySelectorAll('input[name="uploadfile[]"]').length > 0 &&
                        Array.from(document.querySelectorAll('input[name="uploadfile[]"]')).some(input => input.files.length > 0);

        // If no files, submit normally
        if (!hasFiles) {
            this.submit();
            return;
        }

        // Validate all tabs before submission (documentation is optional)
        if (!validateTab('personal') || !validateTab('official')) {
            alert('{% trans "Please fix all validation errors before submitting." %}');

            // Find first invalid tab and show it
            if (!validateTab('personal')) {
                bootstrap.Tab.getInstance(document.querySelector('[data-bs-target="#personal-pane"]')).show();
            } else if (!validateTab('official')) {
                bootstrap.Tab.getInstance(document.querySelector('[data-bs-target="#official-pane"]')).show();
            }
            return;
        }

        // Create FormData and collect all files
        const formData = new FormData(this);
        const files = [];
        const filenames = [];

        // Get all file inputs that have files
        document.querySelectorAll('input[name="uploadfile[]"]').forEach((input, index) => {
            if (input.files[0]) {
                files.push(input.files[0]);
                const filenameInputs = document.querySelectorAll('input[name="filename[]"]');
                filenames.push(filenameInputs[index] ? filenameInputs[index].value : `Document ${index + 1}`);
            }
        });

        // Create a new FormData for the AJAX request
        const mergeFormData = new FormData();
        files.forEach((file, index) => {
            mergeFormData.append('files', file);
            mergeFormData.append('filenames', filenames[index]);
        });
        mergeFormData.append('full_name', formData.get('full_name'));
        mergeFormData.append('document_title', formData.get('document_title'));
        mergeFormData.append('csrfmiddlewaretoken', formData.get('csrfmiddlewaretoken'));

        // Show loading
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Processing..." %}';

        // Send files to server for merging
        fetch('{% url "merge_documents" %}', {
            method: 'POST',
            body: mergeFormData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Set the merged document path and submit the form
                document.getElementById('merged_document_path').value = data.merged_path;
                document.getElementById('revenueSiteForm').submit();
            } else {
                throw new Error(data.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`Error: ${error.message}\n{% trans "Please try again or contact support." %}`);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });

    // Tab validation function (only required fields)
    function validateTab(tabId) {
        const tab = document.getElementById(tabId + '-pane');
        if (!tab) return true;

        // Only validate required fields
        const inputs = tab.querySelectorAll('input[required], select[required], textarea[required]');
        let isValid = true;

        inputs.forEach(input => {
            if (!input.value.trim()) {
                input.classList.add('is-invalid');
                isValid = false;
            } else {
                input.classList.remove('is-invalid');
            }
        });

        return isValid;
    }

    // Remove invalid class when user starts typing
    document.querySelectorAll('input, select, textarea').forEach(input => {
        input.addEventListener('input', function() {
            this.classList.remove('is-invalid');
        });
    });
});
</script>

{% endblock %}